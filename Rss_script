-- GOALKEEPER DEFENSE ZONE SYSTEM v2.0 (No-Lag Edition)
-- Optimized for smooth movement and instant reaction
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local lp = Players.LocalPlayer

-- CONFIGURATION
local Config = {
    ZoneRadius = 30,         -- Радиус зоны защиты (стадов)
    RepulsionForce = 300,    -- Сила отталкивания
    UpwardForce = 50,        -- Сила подбрасывания вверх (чтобы мяч не катился, а летел)
    UpdateRate = 0.015,      -- Скорость обновления (чем меньше, тем быстрее реакция)
    VisualizationEnabled = true
}

-- UI SETUP
local GUI = Instance.new("ScreenGui")
GUI.Name = "DefenseZoneV2"
GUI.ResetOnSpawn = false
GUI.Parent = game.CoreGui

local Toggle = Instance.new("TextButton")
Toggle.Parent = GUI
Toggle.Size = UDim2.fromOffset(60, 60)
Toggle.Position = UDim2.new(0, 20, 0.5, -30)
Toggle.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
Toggle.TextColor3 = Color3.new(1, 1, 1)
Toggle.Text = "ON"
Toggle.TextSize = 18
Toggle.Font = Enum.Font.GothamBlack
local corner = Instance.new("UICorner", Toggle)
corner.CornerRadius = UDim.new(1, 0) -- Круглая кнопка

local SystemActive = true

Toggle.MouseButton1Click:Connect(function()
    SystemActive = not SystemActive
    Toggle.BackgroundColor3 = SystemActive and Color3.fromRGB(0, 170, 255) or Color3.fromRGB(200, 50, 50)
    Toggle.Text = SystemActive and "ON" or "OFF"
end)

-- VISUALIZATION
local ZoneVisual = Instance.new("Part")
ZoneVisual.Name = "DefenseField"
ZoneVisual.Shape = Enum.PartType.Ball
ZoneVisual.Material = Enum.Material.ForceField
ZoneVisual.Color = Color3.fromRGB(0, 170, 255)
ZoneVisual.Transparency = 0.85
ZoneVisual.CanCollide = false
ZoneVisual.Anchored = true
ZoneVisual.CastShadow = false
ZoneVisual.Massless = true
ZoneVisual.Parent = Workspace

-- PHYSICS LOGIC
local OverlapParams = OverlapParams.new()
OverlapParams.FilterType = Enum.RaycastFilterType.Exclude
OverlapParams.FilterDescendantsInstances = {lp.Character} -- Игнорируем себя

local function IsBall(part)
    if not part then return false end
    local name = string.lower(part.Name)
    -- Простой список слов для определения мяча
    return string.find(name, "ball") or 
           string.find(name, "soccer") or 
           string.find(name, "football") or
           string.find(name, "puck") or
           part:GetAttribute("IsBall") == true
end

local function PulseVisual()
    if not Config.VisualizationEnabled then return end
    ZoneVisual.Color = Color3.fromRGB(255, 100, 100)
    ZoneVisual.Transparency = 0.6
    task.delay(0.1, function()
        ZoneVisual.Color = Color3.fromRGB(0, 170, 255)
        ZoneVisual.Transparency = 0.85
    end)
end

local function Repulse(ball, rootPos)
    -- Владение физикой (Network Ownership)
    -- Пытаемся установить скорость, даже если сервер "держит" мяч
    
    local ballPos = ball.Position
    local direction = (ballPos - rootPos).Unit
    
    -- Вектор отталкивания: От игрока + немного вверх
    local forceVector = (direction + Vector3.new(0, 0.2, 0)).Unit * Config.RepulsionForce
    
    -- Если мяч летит В НАС с большой скоростью, отражаем эту скорость обратно
    local currentVel = ball.AssemblyLinearVelocity
    if currentVel.Magnitude > 10 then
        -- Инвертируем скорость мяча и добавляем нашу силу
        ball.AssemblyLinearVelocity = (currentVel * -0.5) + forceVector
    else
        -- Если мяч стоит или еле катится, просто пинаем
        ball.AssemblyLinearVelocity = forceVector + Vector3.new(0, Config.UpwardForce, 0)
    end
    
    -- Добавляем вращение для реалистичности
    ball.AssemblyAngularVelocity = Vector3.new(math.random(-50,50), math.random(-50,50), math.random(-50,50))
    
    PulseVisual()
end

-- MAIN LOOP
local lastCheck = 0

RunService.Heartbeat:Connect(function()
    -- Получаем персонажа
    local char = lp.Character
    local root = char and char:FindFirstChild("HumanoidRootPart")
    
    if not root then 
        ZoneVisual.Transparency = 1 
        return 
    end

    -- Обновляем визуал зоны
    ZoneVisual.Size = Vector3.new(Config.ZoneRadius * 2, Config.ZoneRadius * 2, Config.ZoneRadius * 2)
    ZoneVisual.CFrame = root.CFrame
    ZoneVisual.Transparency = SystemActive and 0.85 or 1
    
    if not SystemActive then return end

    -- Ограничение частоты обновлений (для FPS)
    local now = tick()
    if now - lastCheck < Config.UpdateRate then return end
    lastCheck = now
    
    -- Обновляем список исключений (чтобы не отталкивать себя)
    OverlapParams.FilterDescendantsInstances = {char, ZoneVisual}

    -- МГНОВЕННЫЙ ПОИСК ДЕТАЛЕЙ ВОКРУГ
    local partsInZone = Workspace:GetPartBoundsInRadius(root.Position, Config.ZoneRadius, OverlapParams)
    
    for _, part in ipairs(partsInZone) do
        -- Проверка: это физический объект? это не закреплено? это мяч?
        if part:IsA("BasePart") and not part.Anchored and IsBall(part) then
            -- Дополнительная проверка дистанции (на всякий случай)
            if (part.Position - root.Position).Magnitude <= Config.ZoneRadius then
                Repulse(part, root.Position)
            end
        end
    end
end)

-- CLEANUP
lp.CharacterRemoving:Connect(function()
    ZoneVisual.Transparency = 1
end)

game.Close:Connect(function()
    ZoneVisual:Destroy()
    GUI:Destroy()
end)

print("✅ DEFENSE ZONE V2: MOVEMENT FIXED")
