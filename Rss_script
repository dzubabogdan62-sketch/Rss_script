-- GOALKEEPER DEFENSE SYSTEM v2.1
-- Advanced ball detection with player stability
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local lp = Players.LocalPlayer

local Config = {
    DetectionRadius = 40,
    DeflectionForce = 220,
    ReactionDelay = 0.06,
    CatchRadius = 7,
    PlayerStability = true, -- ЗАЩИТА ОТ ОТЛЁТА
    Debug = true -- ВКЛЮЧЁН DEBUG MODE
}

-- UI Setup
local GUI = Instance.new("ScreenGui")
GUI.Name = "GoalkeeperSystem"
GUI.ResetOnSpawn = false
GUI.Parent = game.CoreGui

local Toggle = Instance.new("TextButton")
Toggle.Parent = GUI
Toggle.Size = UDim2.fromOffset(60, 60)
Toggle.Position = UDim2.new(0, 10, 0.5, -30)
Toggle.BackgroundColor3 = Color3.fromRGB(40, 180, 40)
Toggle.TextColor3 = Color3.new(1, 1, 1)
Toggle.Text = "ON"
Toggle.TextSize = 18
Toggle.Font = Enum.Font.GothamBold
Instance.new("UICorner", Toggle).CornerRadius = UDim.new(0, 12)

local Status = Instance.new("TextLabel")
Status.Parent = GUI
Status.Size = UDim2.fromOffset(180, 40)
Status.Position = UDim2.new(0, 10, 0, 10)
Status.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
Status.BackgroundTransparency = 0.2
Status.TextColor3 = Color3.new(1, 1, 1)
Status.Text = "ACTIVE"
Status.TextSize = 16
Status.Font = Enum.Font.GothamMedium
Instance.new("UICorner", Status).CornerRadius = UDim.new(0, 8)

-- DEBUG PANEL
local DebugPanel = Instance.new("Frame")
DebugPanel.Parent = GUI
DebugPanel.Size = UDim2.fromOffset(250, 200)
DebugPanel.Position = UDim2.new(1, -260, 0, 10)
DebugPanel.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
DebugPanel.BackgroundTransparency = 0.3
Instance.new("UICorner", DebugPanel).CornerRadius = UDim.new(0, 8)

local DebugTitle = Instance.new("TextLabel")
DebugTitle.Parent = DebugPanel
DebugTitle.Size = UDim2.new(1, 0, 0, 25)
DebugTitle.BackgroundTransparency = 1
DebugTitle.Text = "DEBUG INFO"
DebugTitle.TextColor3 = Color3.fromRGB(255, 200, 0)
DebugTitle.TextSize = 14
DebugTitle.Font = Enum.Font.GothamBold

local DebugText = Instance.new("TextLabel")
DebugText.Parent = DebugPanel
DebugText.Size = UDim2.new(1, -10, 1, -30)
DebugText.Position = UDim2.new(0, 5, 0, 25)
DebugText.BackgroundTransparency = 1
DebugText.Text = "Scanning..."
DebugText.TextColor3 = Color3.new(1, 1, 1)
DebugText.TextSize = 12
DebugText.Font = Enum.Font.Code
DebugText.TextXAlignment = Enum.TextXAlignment.Left
DebugText.TextYAlignment = Enum.TextYAlignment.Top
DebugText.TextWrapped = true

local SystemActive = true
Toggle.MouseButton1Click:Connect(function()
    SystemActive = not SystemActive
    Toggle.BackgroundColor3 = SystemActive and Color3.fromRGB(40, 180, 40) or Color3.fromRGB(180, 40, 40)
    Toggle.Text = SystemActive and "ON" or "OFF"
    Status.Text = SystemActive and "ACTIVE" or "DISABLED"
end)

-- Detection Zone Visualization
local DetectionZone = Instance.new("Part")
DetectionZone.Name = "DetectionZone"
DetectionZone.Size = Vector3.new(1, 1, 1)
DetectionZone.Transparency = 0.85
DetectionZone.Color = Color3.fromRGB(40, 180, 40)
DetectionZone.Material = Enum.Material.Neon
DetectionZone.CanCollide = false
DetectionZone.Anchored = true
DetectionZone.Shape = Enum.PartType.Ball
DetectionZone.Parent = Workspace

-- Ball Detection System
local BallCache = {}
local DeflectionCooldown = {}
local DebugInfo = {
    BallsFound = 0,
    LastScan = 0,
    ActiveBall = "None",
    LastAction = "None"
}

local function ScanForBalls()
    local detectedBalls = {}
    local scanLocations = {
        {name = "Workspace", obj = Workspace},
        {name = "Workspace.Balls", obj = Workspace:FindFirstChild("Balls")},
        {name = "Workspace.GameObjects", obj = Workspace:FindFirstChild("GameObjects")},
        {name = "ReplicatedStorage", obj = ReplicatedStorage},
        {name = "ReplicatedStorage.Assets", obj = ReplicatedStorage:FindFirstChild("Assets")},
        {name = "Workspace.Game", obj = Workspace:FindFirstChild("Game")},
        {name = "Workspace.Live", obj = Workspace:FindFirstChild("Live")}
    }
    
    for _, location in ipairs(scanLocations) do
        if location.obj then
            for _, obj in pairs(location.obj:GetDescendants()) do
                if obj:IsA("BasePart") then
                    local name = obj.Name:lower()
                    if name:find("ball") or name:find("soccer") or name:find("football") or name:find("puck") then
                        if obj.Parent and obj.Parent.Parent then
                            table.insert(detectedBalls, {
                                object = obj,
                                location = location.name,
                                name = obj.Name
                            })
                            
                            if Config.Debug then
                                print(string.format("[SCAN] Found: %s in %s", obj.Name, location.name))
                            end
                        end
                    end
                end
            end
        end
    end
    
    DebugInfo.BallsFound = #detectedBalls
    DebugInfo.LastScan = tick()
    
    return detectedBalls
end

local function UpdateDebugPanel()
    if not Config.Debug then
        DebugPanel.Visible = false
        return
    end
    
    DebugPanel.Visible = true
    local text = string.format(
        "Balls Found: %d\nLast Scan: %.1fs ago\nActive Ball: %s\nLast Action: %s\nSystem: %s",
        DebugInfo.BallsFound,
        tick() - DebugInfo.LastScan,
        DebugInfo.ActiveBall,
        DebugInfo.LastAction,
        SystemActive and "ON" or "OFF"
    )
    DebugText.Text = text
end

local function GetClosestBall(position)
    local closest = nil
    local minDistance = Config.DetectionRadius
    
    for _, ballData in ipairs(BallCache) do
        local ball = ballData.object
        if ball and ball.Parent then
            local distance = (ball.Position - position).Magnitude
            if distance < minDistance then
                minDistance = distance
                closest = ball
                DebugInfo.ActiveBall = string.format("%s (%.1fm)", ball.Name, distance)
            end
        end
    end
    
    if not closest then
        DebugInfo.ActiveBall = "None"
    end
    
    return closest, minDistance
end

local function CalculateDeflectionVector(ball, root)
    local ballPosition = ball.Position
    local rootPosition = root.Position
    local ballVelocity = ball.AssemblyLinearVelocity
    
    -- НАПРАВЛЕНИЕ ОТ ВОРОТ (НЕ К ИГРОКУ)
    local awayFromGoal = (ballPosition - rootPosition).Unit
    
    -- Добавляем подъём
    local deflectionDirection = (awayFromGoal + Vector3.new(0, 0.4, 0)).Unit
    
    -- Учёт скорости мяча
    local currentSpeed = ballVelocity.Magnitude
    local speedMultiplier = math.clamp(1 + (currentSpeed / 100), 1, 2)
    
    return deflectionDirection * Config.DeflectionForce * speedMultiplier
end

local function StabilizePlayer(root, humanoid)
    if not Config.PlayerStability then return end
    
    -- КРИТИЧНО: Защита от отлёта игрока
    
    -- 1. Отключаем PlatformStand
    if humanoid.PlatformStand then
        humanoid.PlatformStand = false
    end
    
    -- 2. Ограничиваем вертикальную скорость
    local velocity = root.AssemblyLinearVelocity
    if math.abs(velocity.Y) > 60 then
        root.AssemblyLinearVelocity = Vector3.new(
            velocity.X,
            math.clamp(velocity.Y, -60, 60),
            velocity.Z
        )
    end
    
    -- 3. Убираем горизонтальный отброс от мяча
    if velocity.Magnitude > 80 then
        root.AssemblyLinearVelocity = velocity * 0.3
    end
    
    -- 4. Сброс вращения
    if root.AssemblyAngularVelocity.Magnitude > 10 then
        root.AssemblyAngularVelocity = Vector3.zero
    end
end

local function DeflectBall(ball, root)
    local now = tick()
    if DeflectionCooldown[ball] and (now - DeflectionCooldown[ball]) < 0.25 then
        return false
    end
    DeflectionCooldown[ball] = now
    
    -- ВАЖНО: Сначала стабилизируем игрока
    local humanoid = root.Parent:FindFirstChild("Humanoid")
    if humanoid then
        StabilizePlayer(root, humanoid)
    end
    
    local deflectionVector = CalculateDeflectionVector(ball, root)
    
    -- Применяем силу ТОЛЬКО к мячу
    ball.AssemblyLinearVelocity = deflectionVector
    ball.AssemblyAngularVelocity = Vector3.new(
        math.random(-80, 80),
        math.random(-80, 80),
        math.random(-80, 80)
    )
    
    -- АНТИГЛИТЧ: Телепортируем мяч от игрока
    local safeDistance = Config.CatchRadius + 3
    local direction = (ball.Position - root.Position).Unit
    local dist = (ball.Position - root.Position).Magnitude
    
    if dist < safeDistance then
        ball.CFrame = CFrame.new(root.Position + direction * safeDistance)
    end
    
    -- Visual feedback
    DetectionZone.Color = Color3.fromRGB(255, 100, 100)
    DetectionZone.Size = Vector3.new(Config.DetectionRadius * 2.2, Config.DetectionRadius * 2.2, Config.DetectionRadius * 2.2)
    
    task.delay(0.12, function()
        if DetectionZone then
            DetectionZone.Color = Color3.fromRGB(40, 180, 40)
            DetectionZone.Size = Vector3.new(Config.DetectionRadius * 2, Config.DetectionRadius * 2, Config.DetectionRadius * 2)
        end
    end)
    
    Status.Text = "DEFLECTED"
    DebugInfo.LastAction = string.format("DEFLECT (Force: %.0f)", Config.DeflectionForce)
    
    task.delay(0.4, function()
        if SystemActive then Status.Text = "ACTIVE" end
    end)
    
    if Config.Debug then
        print(string.format("[DEFLECT] Ball: %s | Force: %.0f", ball.Name, deflectionVector.Magnitude))
    end
    
    return true
end

local function CatchBall(ball, root)
    if not ball or not ball.Parent then return false end
    
    local distance = (ball.Position - root.Position).Magnitude
    
    if distance < Config.CatchRadius then
        -- ВАЖНО: Стабилизируем игрока перед ловлей
        local humanoid = root.Parent:FindFirstChild("Humanoid")
        if humanoid then
            StabilizePlayer(root, humanoid)
        end
        
        -- Останавливаем мяч
        ball.AssemblyLinearVelocity = Vector3.zero
        ball.AssemblyAngularVelocity = Vector3.zero
        
        -- Позиционируем перед вратарём
        ball.CFrame = root.CFrame * CFrame.new(0, 0, -4)
        
        DetectionZone.Color = Color3.fromRGB(255, 200, 50)
        task.delay(0.3, function()
            if DetectionZone then DetectionZone.Color = Color3.fromRGB(40, 180, 40) end
        end)
        
        Status.Text = "CAUGHT"
        DebugInfo.LastAction = "CATCH"
        
        task.delay(0.5, function()
            if SystemActive then Status.Text = "ACTIVE" end
        end)
        
        if Config.Debug then
            print(string.format("[CATCH] Ball: %s", ball.Name))
        end
        
        return true
    end
    
    return false
end

local function IsBallApproaching(ball, root)
    local ballVelocity = ball.AssemblyLinearVelocity
    if ballVelocity.Magnitude < 5 then return false end
    
    local toRoot = (root.Position - ball.Position).Unit
    local velocityDirection = ballVelocity.Unit
    
    return velocityDirection:Dot(toRoot) > 0.25
end

-- Update ball cache periodically
task.spawn(function()
    while task.wait(2) do
        BallCache = ScanForBalls()
        if Config.Debug then
            print(string.format("[SYSTEM] Scan complete. Balls found: %d", #BallCache))
        end
    end
end)

-- Main Loop
local lastUpdate = 0
RunService.Heartbeat:Connect(function()
    local character = lp.Character
    local root = character and character:FindFirstChild("HumanoidRootPart")
    local humanoid = character and character:FindFirstChild("Humanoid")
    
    if not root or not humanoid then return end
    
    -- ПОСТОЯННАЯ СТАБИЛИЗАЦИЯ ИГРОКА
    StabilizePlayer(root, humanoid)
    
    -- Update detection zone
    DetectionZone.CFrame = root.CFrame
    DetectionZone.Size = Vector3.new(Config.DetectionRadius * 2, Config.DetectionRadius * 2, Config.DetectionRadius * 2)
    
    -- Update debug panel
    UpdateDebugPanel()
    
    if not SystemActive then
        DetectionZone.Transparency = 1
        return
    end
    
    DetectionZone.Transparency = 0.85
    
    -- Rate limiting
    local now = tick()
    if now - lastUpdate < Config.ReactionDelay then return end
    lastUpdate = now
    
    -- Find closest ball
    local ball, distance = GetClosestBall(root.Position)
    
    if ball then
        -- Priority 1: Catch very close balls
        if CatchBall(ball, root) then
            return
        end
        
        -- Priority 2: Deflect approaching balls
        if IsBallApproaching(ball, root) and distance < Config.DetectionRadius then
            DeflectBall(ball, root)
        end
    end
end)

-- Cleanup
Players.PlayerRemoving:Connect(function(player)
    if player == lp then
        DetectionZone:Destroy()
        GUI:Destroy()
    end
end)

-- Initial scan
BallCache = ScanForBalls()

print("===========================================")
print("GOALKEEPER DEFENSE SYSTEM v2.1 INITIALIZED")
print("Detection Radius:", Config.DetectionRadius)
print("Deflection Force:", Config.DeflectionForce)
print("Player Stability: ENABLED")
print("Debug Mode: ENABLED")
print("Balls Detected:", #BallCache)
print("===========================================")
