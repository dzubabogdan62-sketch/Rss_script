local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local VirtualUser = game:GetService("VirtualUser")
local VirtualInputManager = game:GetService("VirtualInputManager")
local VirtualInputManager = game:GetService("VirtualInputManager")

local Player = Players.LocalPlayer
local _G = _G or {} 

-- // НАСТРОЙКИ //
_G.AutoFarm = false
_G.AutoQuest = false
_G.FruitESP = false
_G.AttackDist = 3
_G.MobileAttackOnly = true
local FruitRespawnPeriod = 3600
local NextFruitSpawn = os.time() + FruitRespawnPeriod

-- // GUI ИНТЕРФЕЙС //
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "BloxFruitMobileGUI_v2"
ScreenGui.Parent = Player:WaitForChild("PlayerGui")
ScreenGui.ResetOnSpawn = false
ScreenGui.DisplayOrder = 1000 -- Максимальный приоритет

-- Кнопка МЕНЮ (Фиксированная позиция для надежности)
local ToggleBtn = Instance.new("TextButton")
ToggleBtn.Name = "ToggleBtn"
ToggleBtn.Parent = ScreenGui
ToggleBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255) -- Синяя, заметная
ToggleBtn.Position = UDim2.new(0.05, 0, 0.15, 0) -- Слева сверху
ToggleBtn.Size = UDim2.new(0, 60, 0, 60)
ToggleBtn.Font = Enum.Font.SourceSansBold
ToggleBtn.Text = "MENU"
ToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleBtn.TextSize = 16
ToggleBtn.ZIndex = 100
ToggleBtn.BorderSizePixel = 2
ToggleBtn.BorderColor3 = Color3.fromRGB(255, 255, 255)
ToggleBtn.Active = true

local UICornerBtn = Instance.new("UICorner")
UICornerBtn.CornerRadius = UDim.new(0.5, 0) -- Круглая
UICornerBtn.Parent = ToggleBtn

-- Основное окно
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
MainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
MainFrame.Size = UDim2.new(0.5, 0, 0.6, 0) -- Побольше для удобства
MainFrame.Visible = false
MainFrame.ZIndex = 101
MainFrame.BorderSizePixel = 0

local UICornerFrame = Instance.new("UICorner")
UICornerFrame.CornerRadius = UDim.new(0.05, 0)
UICornerFrame.Parent = MainFrame

-- Заголовок
local Title = Instance.new("TextLabel")
Title.Parent = MainFrame
Title.Text = "BLOX FRUITS SCRIPT"
Title.Size = UDim2.new(1, 0, 0.15, 0)
Title.BackgroundColor3 = Color3.fromRGB(255, 85, 0)
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.SourceSansBold
Title.TextSize = 18
Title.ZIndex = 102

local UICornerTitle = Instance.new("UICorner")
UICornerTitle.CornerRadius = UDim.new(0.1, 0)
UICornerTitle.Parent = Title

-- Логика переключения меню
ToggleBtn.Activated:Connect(function()
    MainFrame.Visible = not MainFrame.Visible
end)

-- Функция создания кнопок (Toggle)
local function CreateSwitch(text, defaultVal, callback)
    local btn = Instance.new("TextButton")
    btn.Parent = MainFrame
    btn.BackgroundColor3 = defaultVal and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(200, 0, 0)
    btn.Size = UDim2.new(0.9, 0, 0.15, 0)
    btn.Position = UDim2.new(0.05, 0, 0.2 + (#MainFrame:GetChildren() - 2) * 0.18, 0)
    btn.Text = text .. ": " .. (defaultVal and "ON" or "OFF")
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.Font = Enum.Font.SourceSansBold
    btn.TextSize = 16
    btn.ZIndex = 103
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0.2, 0)
    corner.Parent = btn
    
    btn.Activated:Connect(function()
        local isOn = not (btn.Text:find("ON") ~= nil)
        btn.Text = text .. ": " .. (isOn and "ON" or "OFF")
        btn.BackgroundColor3 = isOn and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(200, 0, 0)
        callback(isOn)
    end)
end

-- Добавляем кнопки
CreateSwitch("Auto Farm", _G.AutoFarm, function(val) _G.AutoFarm = val end)
CreateSwitch("Auto Quest", _G.AutoQuest, function(val) _G.AutoQuest = val end)
CreateSwitch("Fruit ESP", _G.FruitESP, function(val) _G.FruitESP = val end)

-- Кнопка закрытия
local CloseBtn = Instance.new("TextButton")
CloseBtn.Parent = MainFrame
CloseBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
CloseBtn.Size = UDim2.new(0.4, 0, 0.12, 0)
CloseBtn.Position = UDim2.new(0.3, 0, 0.85, 0)
CloseBtn.Text = "HIDE MENU"
CloseBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseBtn.Font = Enum.Font.SourceSansBold
CloseBtn.ZIndex = 103

local UICornerClose = Instance.new("UICorner")
UICornerClose.CornerRadius = UDim.new(0.2, 0)
UICornerClose.Parent = CloseBtn

CloseBtn.Activated:Connect(function()
    MainFrame.Visible = false
end)

local FruitTimerLabel = Instance.new("TextLabel")
FruitTimerLabel.Parent = ScreenGui
FruitTimerLabel.Position = UDim2.new(0.05, 0, 0.08, 0)
FruitTimerLabel.Size = UDim2.new(0, 220, 0, 30)
FruitTimerLabel.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
FruitTimerLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
FruitTimerLabel.Font = Enum.Font.SourceSansBold
FruitTimerLabel.TextSize = 14
FruitTimerLabel.ZIndex = 110
FruitTimerLabel.Text = "Фрукты: —"

-- // ЛОГИКА СКРИПТА //

-- // КОНФИГУРАЦИЯ КВЕСТОВ (FIRST SEA) //
local QuestList = {
    {Req=0, Name="BanditQuest1", Id=1, Mob="Bandit"},
    {Req=10, Name="JungleQuest", Id=1, Mob="Monkey"},
    {Req=15, Name="JungleQuest", Id=2, Mob="Gorilla"},
    {Req=25, Name="JungleQuest", Id=3, Mob="Gorilla King"},
    {Req=30, Name="BuggyQuest1", Id=1, Mob="Pirate"},
    {Req=40, Name="BuggyQuest1", Id=2, Mob="Brute"},
    {Req=60, Name="DesertQuest", Id=1, Mob="Desert Bandit"},
    {Req=75, Name="DesertQuest", Id=2, Mob="Desert Officer"},
    {Req=90, Name="SnowQuest", Id=1, Mob="Snow Bandit"},
    {Req=100, Name="SnowQuest", Id=2, Mob="Snowman"},
    {Req=120, Name="MarineQuest2", Id=1, Mob="Chief Petty Officer"},
    {Req=150, Name="SkyQuest", Id=1, Mob="Sky Bandit"},
    {Req=175, Name="SkyQuest", Id=2, Mob="Dark Master"},
    {Req=190, Name="PrisonerQuest", Id=1, Mob="Prisoner"},
    {Req=210, Name="PrisonerQuest", Id=2, Mob="Dangerous Prisoner"},
    {Req=225, Name="ColosseumQuest", Id=1, Mob="Toga Warrior"},
    {Req=275, Name="ColosseumQuest", Id=2, Mob="Gladiator"},
    {Req=300, Name="MagmaQuest", Id=1, Mob="Military Soldier"},
    {Req=325, Name="MagmaQuest", Id=2, Mob="Military Spy"},
    {Req=375, Name="FishmanQuest", Id=1, Mob="Fishman Warrior"},
    {Req=400, Name="FishmanQuest", Id=2, Mob="Fishman Commando"},
    {Req=450, Name="SkyExp1Quest", Id=1, Mob="God's Guard"},
    {Req=475, Name="SkyExp1Quest", Id=2, Mob="Shanda"},
    {Req=525, Name="SkyExp2Quest", Id=1, Mob="Royal Squad"},
    {Req=625, Name="FountainQuest", Id=1, Mob="Galley Pirate"},
    {Req=650, Name="FountainQuest", Id=2, Mob="Galley Captain"}
}

local function GetCurrentQuestConfig(level)
    for i = #QuestList, 1, -1 do
        if level >= QuestList[i].Req then
            return QuestList[i]
        end
    end
    return QuestList[1]
end

local function GetQuestTarget()
    local gui = Player:FindFirstChild("PlayerGui")
    if gui and gui:FindFirstChild("Main") and gui.Main:FindFirstChild("Quest") then
        local q = gui.Main.Quest
        if q.Visible then
            local t = q.Container.QuestTitle.Title.Text
            -- Проверяем всех мобов из списка
            for _, cfg in pairs(QuestList) do
                if string.find(t, cfg.Mob) then return cfg.Mob end
            end
            -- Доп. проверки если название в квесте отличается (множественное число и т.д.)
            if string.find(t, "Bandit") then return "Bandit" end
            if string.find(t, "Monkey") then return "Monkey" end
            if string.find(t, "Gorilla") then return "Gorilla" end
            if string.find(t, "Gorilla King") then return "Gorilla King" end
            if string.find(t, "Pirate") then return "Pirate" end
            if string.find(t, "Galley Pirate") then return "Galley Pirate" end
        end
    end
    return nil
end

local function EquipBest()
    local char = Player.Character
    if not char then return end
    local tool = char:FindFirstChildOfClass("Tool")
    if tool then return tool end
    for _, t in pairs(Player.Backpack:GetChildren()) do
        if t:IsA("Tool") and (t.ToolTip == "Melee" or t.Name == "Combat" or t.ToolTip == "Sword") then
            char.Humanoid:EquipTool(t)
            return t
        end
    end
end

-- Автофарм цикл
task.spawn(function()
    while task.wait() do
        if _G.AutoFarm and Player.Character and Player.Character:FindFirstChild("HumanoidRootPart") then
            pcall(function()
                -- 1. Квест
                if _G.AutoQuest then
                    local gui = Player.PlayerGui
                    if gui.Main.Quest.Visible == false then
                        local lvl = Player.Data.Level.Value
                        local questConfig = GetCurrentQuestConfig(lvl)
                        if questConfig then
                            ReplicatedStorage.Remotes.CommF_:InvokeServer("StartQuest", questConfig.Name, questConfig.Id)
                        end
                    end
                end

                -- 2. Цель
                local targetName = GetQuestTarget()
                local target = nil
                local enemies = Workspace:FindFirstChild("Enemies")
                if enemies then
                    for _, v in pairs(enemies:GetChildren()) do
                        if v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 and v:FindFirstChild("HumanoidRootPart") then
                            if not targetName or string.find(v.Name, targetName) then
                                target = v
                                break -- Бьем первого найденного
                            end
                        end
                    end
                end

                -- 3. Атака
                if target then
                    local weapon = EquipBest()
                    local targetPos = target.HumanoidRootPart.CFrame * CFrame.new(0, 2, -_G.AttackDist)
                    
                    Player.Character.HumanoidRootPart.CFrame = targetPos
                    Player.Character.HumanoidRootPart.Velocity = Vector3.zero
                    
                    if weapon then 
                        weapon:Activate()
                        if _G.MobileAttackOnly then
                            local cam = Workspace.CurrentCamera
                            local cx = math.floor(cam.ViewportSize.X/2)
                            local cy = math.floor(cam.ViewportSize.Y/2)
                            task.spawn(function()
                                pcall(function()
                                    VirtualInputManager:SendMouseButtonEvent(cx, cy, 0, true, game, 1)
                                    task.wait(0.02)
                                    VirtualInputManager:SendMouseButtonEvent(cx, cy, 0, false, game, 1)
                                end)
                            end)
                        else
                            pcall(function()
                                VirtualUser:CaptureController()
                                VirtualUser:ClickButton1(Vector2.new(800, 600), Workspace.CurrentCamera.CFrame)
                            end)
                        end
                    end
                end
            end)
        end
    end
end)

-- ESP цикл
task.spawn(function()
    while task.wait(0.5) do
        if _G.FruitESP then
            pcall(function()
                local found = 0
                for _, v in pairs(Workspace:GetChildren()) do
                    if string.find(v.Name, "Fruit") and v:IsA("Tool") and v:FindFirstChild("Handle") then
                        if not v.Handle:FindFirstChild("FruitESP") then
                            local b = Instance.new("BillboardGui")
                            b.Name = "FruitESP"
                            b.Adornee = v.Handle
                            b.Size = UDim2.new(0, 200, 0, 50)
                            b.StudsOffset = Vector3.new(0, 2, 0)
                            b.AlwaysOnTop = true
                            
                            local t = Instance.new("TextLabel")
                            t.Parent = b
                            t.Size = UDim2.new(1,0,1,0)
                            t.BackgroundTransparency = 1
                            t.TextColor3 = Color3.fromRGB(255, 0, 0)
                            t.TextStrokeTransparency = 0
                            t.Font = Enum.Font.SourceSansBold
                            t.TextSize = 14
                            t.Text = v.Name
                            b.Parent = v.Handle
                        end
                        -- Обновление дистанции
                        if v.Handle:FindFirstChild("FruitESP") then
                            local dist = math.floor((Player.Character.HumanoidRootPart.Position - v.Handle.Position).Magnitude)
                            v.Handle.FruitESP.TextLabel.Text = v.Name .. " [" .. dist .. "m]"
                        end
                        found = found + 1
                    end
                end
                if found > 0 then
                    FruitTimerLabel.Text = "Фрукты: " .. found
                    NextFruitSpawn = os.time() + FruitRespawnPeriod
                else
                    local left = math.max(0, NextFruitSpawn - os.time())
                    local m = math.floor(left/60)
                    local s = left % 60
                    FruitTimerLabel.Text = string.format("Нет фруктов • спавн через %02d:%02d", m, s)
                    if left == 0 then
                        NextFruitSpawn = os.time() + FruitRespawnPeriod
                    end
                end
            end)
        else
            -- Очистка
            for _, v in pairs(Workspace:GetChildren()) do
                if v:FindFirstChild("Handle") and v.Handle:FindFirstChild("FruitESP") then
                    v.Handle.FruitESP:Destroy()
                end
            end
            local left = math.max(0, NextFruitSpawn - os.time())
            local m = math.floor(left/60)
            local s = left % 60
            FruitTimerLabel.Text = string.format("Нет фруктов • спавн через %02d:%02d", m, s)
        end
    end
end)

-- Noclip (Delta X fix)
RunService.Stepped:Connect(function()
    if _G.AutoFarm and Player.Character then
        for _, v in pairs(Player.Character:GetDescendants()) do
            if v:IsA("BasePart") then v.CanCollide = false end
        end
    end
end)
